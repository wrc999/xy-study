<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>活动管理</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="Shortcut Icon" href="../images/xy.ico">
  <link rel="stylesheet" href="../layui/css/layui.css"  media="all">
<style>
	*{
		paddint:0;
		margin:0;
	}
</style>
</head>
<body>
	<div id="toolbar">
	<blockquote class="layui-elem-quote quoteBox">
    <form class="layui-form">
        <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text"  id="search" class="layui-input searchVal" placeholder="请输入搜索的活动名" />
            </div>
            <a class="layui-btn search_btn" data-type="look">搜索</a>
        </div>
        <div class="layui-inline">
            <a class="layui-btn layui-btn-normal addmkwh_btn" data-type="edit">编辑</a>
        </div>
        <div class="layui-inline">
        <a class="layui-btn layui-btn-danger layui-btn-normal delAll_btn" data-type="add">添加</a>
        </div>
        <div class="layui-inline">
        <a class="layui-btn layui-btn-danger layui-btn-normal delAll_btn" data-type="del">删除</a>
        </div>
    </form>
</blockquote>
	</div>
	<table class="layui-table" id="table" lay-data="{url:'/xy/activity/adminGet'
										  			,method: 'post'
										  			,cellMinWidth:80
										  			,fit:true
													,page:true
											  		,limits:[10,30,50,100]
											  		,height:'full-70'
	  												,id:'tabId'}" 
	  		lay-filter="demo">
		<thead>
		    <tr>
		      <th lay-data="{type:'checkbox'}"></th>
		      <th lay-data="{field:'activity_id',sort:true}">ID</th>
		      <th lay-data="{field:'account'}">发起人</th>
		      <th lay-data="{field:'name'}">活动名</th>
		      <th lay-data="{field:'starttime'}">开始时间</th>
		      <th lay-data="{field:'endtime'}">结束时间</th>
		      <th lay-data="{field:'place'}">活动地点</th>
		      <th lay-data="{field:'peopleNum'}">活动人数</th>
		      <th lay-data="{field:'ava'}">活动海报</th>
		      <th lay-data="{field:'intro'}">活动简介</th>
		      <th lay-data="{field:'keyword'}">活动分类</th>
		      <th lay-data="{field:'online'}">是否线上</th>
		      <th lay-data="{field:'pic1'}">活动照片1</th>
		      <th lay-data="{field:'pic2'}">活动照片2</th>
		      <th lay-data="{field:'pic3'}">活动照片3</th>
		      <th lay-data="{field:'activityPass'}">是否审核</th>
		    </tr>
		  </thead>
	</table>
<div id="editDialog" style="display:none;">
	<form class="layui-form" lay-filter="activity" method="post">
    		<input name="activity_id" id="activity_id" type="hidden">
		<div class="layui-form-item">
		    <label class="layui-form-label">发起人：</label>
		    <div class="layui-input-block">
		      <input name="account"  id="account" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动名：</label>
		    <div class="layui-input-block">
		      <input name="name" id="name" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">开始时间：</label>
		    <div class="layui-input-block">
		      <input name="starttime" id="starttime" readonly class="layui-input date" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">结束时间：</label>
		    <div class="layui-input-block">
		      <input name="endtime" id="endtime" readonly class="layui-input date" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动地点：</label>
		    <div class="layui-input-block">
		      <input name="place" id="place" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动人数：</label>
		    <div class="layui-input-block">
		      <input name="peopleNum" id="peopleNum" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动海报：</label>
		    <div class="layui-input-block">
		      <input name="ava" id="ava" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动简介：</label>
		    <div class="layui-input-block">
		      <input name="intro" id="intro" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动分类：</label>
		    <div class="layui-input-block">
		      <input name="keyword" id="keyword" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">是否线上：</label>
		    <div class="layui-input-block">
		      <input name="online" id="online" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动照片1：</label>
		    <div class="layui-input-block">
		      <input name="pic1" id="pic1" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动照片2：</label>
		    <div class="layui-input-block">
		      <input name="pic2" id="pic2" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">活动照片3：</label>
		    <div class="layui-input-block">
		      <input name="pic3" id="pic3" class="layui-input" style="width:60%">
		    </div>
		</div>
		<div class="layui-form-item">
		    <label class="layui-form-label">是否审核：</label>
		    <div class="layui-input-block">
		      <input name="activityPass" id="activityPass" class="layui-input" style="width:60%">
		    </div>
		</div>
  </form>
</div>
<script src="../layui/layui.js" charset="utf-8"></script>
<script>
	layui.use(['table','element','laydate','form','layer'], function(){
		//左侧导航栏收缩
		var element = layui.element;
		//初始化日期
		var laydate = layui.laydate;
		var layer = layui.layer
		//初始化表单
		var form = layui.form;
		//同时绑定多个时间选择器
		  lay('.date').each(function(){
		    laydate.render({
		      elem: this
		      ,trigger: 'click'
		      ,theme: 'molv'
		      ,format: 'yyyy.MM.dd'
		    });
		  });
		//初始数据表格（方法渲染）
  		var table = layui.table;
  		var $ = layui.$;
  		$('#toolbar .layui-btn').on('click', function(){
  	  	    var type = $(this).data('type');
  	  	    active[type] ? active[type].call(this) : '';
  	  	  });
  	  	active = {
  	  	//搜索
		 look: function(){ //获取选中数据
	 	     var search = $("#search").val();
	 	     table.reload('tabId', {
	 	    	 url:'/xy/activity/adminGet'
	 	    	  ,where: { //设定异步数据接口的额外参数，任意设
	 	    		 account: search
	 	    	  }
	 	    	  ,page: {
	 	    	    curr: 1 //重新从第 1 页开始
	 	    	  }
	 	    	});
	 	    }
  		//添加
  	    ,add: function(){ //添加数据
  	    	//初始化弹出框数据
  	    	form.val("activity", {
   	    	 "account":null
   	    	,"name": null
   	    	,"starttime": null
   	  		,"endtime":null
   	  		,"place":null
   	  		,"peopleNum":null
   	    	,"ava": null
   	  		,"intro":null
   	  		,"keyword":null
   	  		,"online":null
   	  		,"pic1":null
   	    	,"pic2": null
   	  		,"pic3":null
   	  		,"activityPass":null
   	    	});
  	    	layer.open({
	          type: 1
	          ,title: "发布活动" //不显示标题栏
	          ,closeBtn: 2
	          ,area: ['30%', '80%']
	          ,shade: 0
	          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
	          ,btn: ['添加', '取消']
	          ,btnAlign: 'c'//按钮居中
	          ,moveType: 0 //拖拽模式，0或者1
	          ,content: $('#editDialog')
	          ,success: function(layero){
	            var btn = layero.find('.layui-layer-btn');
	            	btn.find('.layui-layer-btn0').on('click', function(){
			            	var account = $("#account").val();
			            	var name = $("#name").val();
			            	var starttime = $("#starttime").val();
			            	var endtime = $("#endtime").val();
			            	var place = $("#place").val();
			            	var peopleNum = $("#peopleNum").val();
			            	var ava = $("#ava").val();
			            	var intro = $("#intro").val();
			            	var keyword = $("#keyword").val();
			            	var online = $("#online").val();
			            	var pic1 = $("#pic1").val();
			            	var pic2 = $("#pic2").val();
			            	var pic3 = $("#pic3").val();
			            	var activityPass = $("#activityPass").val();
			            	$.post(
			            			"/xy/activity/add",
			            	        {
			            				account: account,
			            			 	name: name,
			            			 	starttime: starttime,
			            			 	endtime: endtime,
			            			 	place: place,
			            			 	peopleNum: peopleNum,
			            			 	ava: ava,
			            			 	intro: intro,
			            			 	keyword: keyword,
			            			 	online: online,
			            			 	pic1: pic1,
			            			 	pic2: pic2,
			            			 	pic3: pic3,
			            			 	activityPass: activityPass
			            				},
			            	        function(result){
			            	          table.reload('tabId',{});     
			            	          layer.msg('添加成功');
			            	          $.post(
						            			"/xy/admin/add",
						            	        {
						            				account: layui.sessionData('userInfo').account.account,
						            			 	details: "添加了活动"+name,
						            				},
						            	        function(result){
						            	          layer.msg('添加日志成功')
						            	      });
			            	      });
		        	  });
	          }
	        });
  	    }
  		//修改
  	    ,edit: function(){ //修改选中数据
  	    	var checkStatus = table.checkStatus('tabId');
    	      var data = checkStatus.data;
    	      if(data.length==0){
    	    	  layer.msg("不选择修改用户你让我如何编辑哟")
    	      }else if(data.length>1){
    	    	  layer.msg("请不要多选哟")
    	      }else{
    	    	  form.val("activity", {
    	    		  	"activity_id":data[0].activity_id
    	    		  	,"account":data[0].account
    	     	    	,"name": data[0].name
    	     	    	,"starttime": data[0].starttime
    	     	  		,"endtime":data[0].endtime
    	     	  		,"place":data[0].place
    	     	  		,"peopleNum":data[0].peopleNum
    	     	    	,"ava": data[0].ava
    	     	  		,"intro":data[0].intro
    	     	  		,"keyword":data[0].keyword
    	     	  		,"online":data[0].online
    	     	  		,"pic1":data[0].pic1
    	     	    	,"pic2": data[0].pic2
    	     	  		,"pic3":data[0].pic3
    	     	  		,"activityPass":data[0].activityPass
    	    	    	});
    	  	    	layer.open({
    	  	          type: 1
    	  	          ,title: "修改活动信息" //不显示标题栏
    	  	          ,closeBtn: 2
    	  	          ,area: ['30%', '80%']
    	  	          ,shade: 0
    	  	          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
    	  	          ,btn: ['保存', '取消']
    	  	          ,btnAlign: 'c'//按钮居中
    	  	          ,moveType: 0 //拖拽模式，0或者1
    	  	          ,content: $('#editDialog')
    	  	          ,success: function(layero){
    	  	            var btn = layero.find('.layui-layer-btn');
    	  	            btn.find('.layui-layer-btn0').on('click', function(){
    	  	            	var activity_id = $("#activity_id").val();
    	  	            	var account = $("#account").val();
			            	var name = $("#name").val();
			            	var starttime = $("#starttime").val();
			            	var endtime = $("#endtime").val();
			            	var place = $("#place").val();
			            	var peopleNum = $("#peopleNum").val();
			            	var ava = $("#ava").val();
			            	var intro = $("#intro").val();
			            	var keyword = $("#keyword").val();
			            	var online = $("#online").val();
			            	var pic1 = $("#pic1").val();
			            	var pic2 = $("#pic2").val();
			            	var pic3 = $("#pic3").val();
			            	var activityPass = $("#activityPass").val();
			            	layer.msg('保存修改成功');
    	  	            	$.post(
    	  	            			"/xy/activity/edit",
    	  	            	        {activity_id: activity_id,
    	  	            				account: account,
			            			 	name: name,
			            			 	starttime: starttime,
			            			 	endtime: endtime,
			            			 	place: place,
			            			 	peopleNum: peopleNum,
			            			 	ava: ava,
			            			 	intro: intro,
			            			 	keyword: keyword,
			            			 	online: online,
			            			 	pic1: pic1,
			            			 	pic2: pic2,
			            			 	pic3: pic3,
			            			 	activityPass: activityPass
    	  	            				},
    	  	            	        function(result){
    	  	            	          table.reload('tabId',{});          
    	  	            	          layer.msg('保存修改成功');
    	  	            	        $.post(
					            			"/xy/admin/add",
					            	        {
					            				account: layui.sessionData('userInfo').account.account,
					            			 	details: "修改了活动"+name,
					            				},
					            	        function(result){
					            	          layer.msg('添加日志成功')
					            	      });
    	  	            	      });
    	  	        	  });
    	  	          }
    	  	        });
    	      }
    	      
  	    }
  		//删除
  	    ,del: function(){ //删除选中数据
  	    	var checkStatus = table.checkStatus('tabId');
    	    var data = checkStatus.data;
    	    //判断用户选择了多少行
    	    if(data.length==0){
    	    	layer.msg("请选择删除哪一行哟");
    	    }else{
    	    	layer.confirm('是否删除？', {icon: 3, title:'提示'}, function(index){
    	    		  //do something
    	    		//多行删除
        	    	for(var i=0;i<data.length;i++){
    		    	    var activity_id = data[i].activity_id;
    		    	    var name = data[i].name;
    		    	    $.post(
    		          			"/xy/activity/delete",
    		          	        {activity_id:activity_id},
    		          	        function(result){
    		          	          table.reload('tabId',{});
	    		          	      $.post(
					            			"/xy/admin/add",
					            	        {
					            				account: layui.sessionData('userInfo').account.account,
					            			 	details: "删除了活动"+name,
					            				},
					            	        function(result){
					            	          layer.msg('添加日志成功')
					            	      });
    		          	      });
        	    	}
		          	layer.msg("已删除"+data.length+"个用户");
    	    		  layer.close(index);
    	    		});
    	    }
  	    },
  	  };
  	  
  	//单击行勾选checkbox事件
  	$(document).on("click",".layui-table-body table.layui-table tbody tr", function () {
  	    //返回被选元素的属性值。
  		var index = $(this).attr('data-index');
  		//查找当前元素的父元素中带有 "layui-table-box" 类的父元素：
  	    var tableBox = $(this).parents('.layui-table-box');
  	    //存在固定列
  	    if (tableBox.find(".layui-table-fixed.layui-table-fixed-l").length>0) {
  	        tableDiv = tableBox.find(".layui-table-fixed.layui-table-fixed-l");
  	    } else {
  	        tableDiv = tableBox.find(".layui-table-body.layui-table-main");
  	    }
  	    var checkCell = tableDiv.find("tr[data-index=" + index + "]").find("td div.laytable-cell-checkbox div.layui-form-checkbox I");
  	    if (checkCell.length>0) {
  	        checkCell.click();
  	    }
  	});

  	$(document).on("click", "td div.laytable-cell-checkbox div.layui-form-checkbox", function (e) {
  	    e.stopPropagation();
  	});
});
</script>

</body>
</html>